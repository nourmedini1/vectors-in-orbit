
services:
  # --- INFRASTRUCTURE ---
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: nexus_zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - nexus_network

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: nexus_kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_NUM_PARTITIONS: 1
    networks:
      - nexus_network

  qdrant:
    image: qdrant/qdrant:latest
    container_name: nexus_qdrant
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_data:/qdrant/storage
    networks:
      - nexus_network

  mongo:
    image: mongo:latest
    container_name: nexus_mongo
    ports:
      - "27017:27017"
    volumes:
      - ./mongo_data:/data/db
    networks:
      - nexus_network

  # --- MICROSERVICES ---

  embedding_service:
    build:
      context: ./embedding_service
      dockerfile: Dockerfile
    container_name: nexus_embedding
    ports:
      - "8001:8000"
    environment:
      - HF_HOME=/app/model_cache
    networks:
      - nexus_network

  product_vectorizer:
    build:
      context: .
      dockerfile: product_vectorizer/Dockerfile
    container_name: nexus_prod_vectorizer
    depends_on:
      - kafka
      - qdrant
      - embedding_service # <--- DEPENDENCY
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - EMBEDDING_SERVICE_URL=http://embedding_service:8000 # <--- URL
    networks:
      - nexus_network

  user_profiler:
    build:
      context: .
      dockerfile: user_profiler/Dockerfile
    container_name: nexus_user_profiler
    depends_on:
      - kafka
      - qdrant
      - embedding_service # <--- ADDED DEPENDENCY
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - EMBEDDING_SERVICE_URL=http://embedding_service:8000 # <--- ADDED URL
    networks:
      - nexus_network

  search_engine:
    build:
      context: .
      dockerfile: search_engine/Dockerfile
    container_name: nexus_search_engine
    ports:
      - "8002:8002"
    depends_on:
      - kafka
      - qdrant
      - embedding_service
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - EMBEDDING_SERVICE_URL=http://embedding_service:8002
    networks:
      - nexus_network

  # --- API GATEWAY ---
  api_gateway:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: nexus_api_gateway
    ports:
      - "8008:8000"
    depends_on:
      - kafka
      - qdrant
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    networks:
      - nexus_network
  
  # --- MONGO --- BACKEND ---
  mongo_backend:
    build:
      context: .
      dockerfile: mongo_backend/Dockerfile
    container_name: nexus_mongo_backend
    ports:
      - "8000:8000"
    environment:
      - API_GATEWAY_URL=http://api_gateway:8000
      - MONGO_URI=mongodb://mongo:27017/
      - DATABASE_NAME=nexus_ai_store
    depends_on:
      - mongo
      - api_gateway
    networks:
      - nexus_network

  # FRONTEND ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_MONGO_BACKEND_URL: http://localhost:8000
        VITE_API_GATEWAY_URL: http://localhost:8008
        VITE_SEARCH_API_URL: http://localhost:8002
    container_name: nexus_frontend
    ports:
      - "80:80"
    depends_on:
      - zookeeper
      - kafka
      - qdrant
      - mongo
      - embedding_service
      - product_vectorizer
      - user_profiler
      - search_engine
      - api_gateway
      - mongo_backend
    networks:
      - nexus_network
    environment:
      - VITE_MONGO_BACKEND_URL=http://localhost:8000
      - VITE_API_GATEWAY_URL=http://localhost:8008
      - VITE_SEARCH_API_URL=http://localhost:8002

networks:
  nexus_network:
    driver: bridge